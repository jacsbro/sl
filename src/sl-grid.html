<!-- import CSS mixin shim -->
<link rel="import" href="../bower_components/shadycss/apply-shim.html">
<!-- import Polymer.Element -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">


<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-filter.html">

<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="sl-grid">

  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
    </style>

    <custom-style>
      <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors"></style>
    </custom-style>

    <div class="vertical-section-container centered">
      <vaadin-grid id="slTable" items="[[_itemsDisplay]]" size="[[size]]" style="height: 90vh">

       <vaadin-grid-column width = "50%">
          <template class="header">
            <vaadin-grid-filter path="name" value="[[_filterName]]" on-value-changed="_filterChanged">
              <vaadin-grid-sorter id="name" path="name" slot="filter">
                <input placeholder="{{localize('article')}}" value="{{_filterName::input}}" focus-target>
              </vaadin-grid-sorter>
            </vaadin-grid-filter>
          </template>
          <template><div id="name" on-tap="_toggleExpanded">[[item.name]]</div></template>
          <template class="row-details">
            <div style="width: 100%">
              <input id="name-[[item.id]]" value="[[item.name]]" on-focusout="_storeName" style="width: 40%" class="marginleft">
              <input id="qty-[[item.id]]" value="[[item.qty]]" on-focusout="_storeQty" style="width: 10%" class="marginleft">
              <paper-icon-button icon="check" on-tap="_toggleExpanded"></paper-icon-button>
            </div>
          </template>
        </vaadin-grid-column>

        <vaadin-grid-column width = "10%">
          <template class="header"></template>
          <template><div id="qty" on-tap="_toggleExpanded">[[item.qty]]</div></template>
        </vaadin-grid-column>

        <vaadin-grid-column width = "10%">
          <template class="header">
            <paper-checkbox checked="{{_isNeededmode}}" on-change="_neededModeChanged"></paper-checkbox>
          </template>
          <template><paper-checkbox id="[[item.id]]" checked="{{item.needed}}" on-change="_neededChanged"></paper-checkbox></template>
        </vaadin-grid-column>

        <vaadin-grid-column width = "10%">
          <template class="header">
            <paper-checkbox checked="{{_isCompletedmode}}" on-change="_completedModeChanged"></paper-checkbox>
          </template>
          <template><paper-checkbox id="[[item.id]]" checked="{{item.done}}" on-change="_doneChanged"></paper-checkbox></template>
        </vaadin-grid-column>

        <vaadin-grid-column width = "10%">
          <template><paper-icon-button id="[[item.id]]" icon="add" on-tap="_addPressed"></paper-icon-button></template>
        </vaadin-grid-column>

        <vaadin-grid-column width = "10%">
          <template><paper-icon-button id="[[item.id]]" icon="delete" on-tap="_deletePressed"></paper-icon-button></template>
        </vaadin-grid-column>

      </vaadin-grid>
    </div>

  </template>
  <script>
    class SlGrid extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {

      static get is() { return 'sl-grid'; }

      static get properties() {
        return {
          // shopping list to show
          data: {
            type: Object,
            notify: true,
            observer: '_dataChanged'
          },

          // shopping list to show
          _itemsDisplay: {
            type: Array,
            notify: true
          },

          // true if only needed should be displayed
          __isNeededmode: {
            type: Boolean,
            value: false,
            notify: true
          },

          // true if completed should be hidden
          _isCompletedmode: {
            type: Boolean,
            value: false
          },          
        };
      }

      // observer for changed data
      _dataChanged(aData) {
        if (aData && aData.items) {
          console.log("setting shopping list to sl-grid (" + aData.items.length + " items)");
          this._itemsDisplay = aData.items.slice(0);
        }
      }

      //-----------------------------------------------------------------------
      // add an item
      //-----------------------------------------------------------------------
      /**
       * add
       */
      _addPressed(data) {
        for( var i=0; i<this._itemsDisplay.length;i++) {
          if(this._itemsDisplay[i].id === data.target.id) {
            this._newItem(i+1, data.target.id);
            return;
          }
        }
      }

      _newItem(index, idBefore) {
        var theNew = new ShoppingListItem("", UNIT_ST, 1, false, true);
        this.splice('_itemsDisplay', index, 0, theNew);
        for (var i=0; i<this.data.items.length; i++) {
          if (this.data.items[i].id === idBefore) {
            this.splice('data.items', i, 0, theNew);
            return;
          }
        }
      }


      //-----------------------------------------------------------------------
      // edit an item
      //-----------------------------------------------------------------------

      _toggleExpanded(e)  {
        var item = e.model.item;
        if (e.model.expanded) {
          this.$.slTable.collapseItem(item);
        } else {
          this.$.slTable.expandItem(item);
          if (e.target.id.includes("qty")) {
            this._focusQty(item);  
          } else {
            this._focusName(item);
          }
        }
        
      }

      _storeName(e) {
        var item = e.model.item;
        if (item) {
          item.name = e.target.value;
          this._clearCache();
        }        
      }

      _storeQty(e) {
        var item = e.model.item;
        if (item) {
          item.qty = e.target.value;
          this._clearCache();
        }        
      }

      _clearCache() {
        this.$.slTable.clearCache();
      }

      _focusName(item) {
        this._focusId(this._getNameId(item));
      }

      _focusQty(item) {
        this._focusId(this._getQtyId(item));
      }

      _getNameId(item) {
        return '#name-' + item.id;
      }

      _getQtyId(item) {
        return '#qty-' + item.id;
      }

      _focusId(id) {
        var el = this.$.slTable.querySelector(id);
        el.focus();
        el.setSelectionRange(0, el.value.length)
      }

      //-----------------------------------------------------------------------
      // delete an item
      //-----------------------------------------------------------------------
      /**
       * delete an item
       */
      _deletePressed(data) {
        var id2Delete = data.target.id;
        for( var i=0; i<this._itemsDisplay.length;i++) {
          if(this._itemsDisplay[i].id === id2Delete) {
            this.splice('_itemsDisplay', i, 1);
            for (var j=0; j<this.data.items.length; j++) {
              if (this.data.items[j].id === id2Delete) {
                this.splice('data.items', j, 1);
                return;
              }
            }
          }
        }
      }


      //-----------------------------------------------------------------------
      // code for needed property
      //-----------------------------------------------------------------------
       // called when needed is changed on an article
      _neededChanged(e) {
        var checked = e.target.checked;
        var id = e.target.id;
        if (this._isNeededmode && !checked) {
          this._spliceId(id);
        }
      }

       // called when needed mode is changed
      _neededModeChanged(e) {
        var checked = e.target.checked;
        var tmp = [];
        if (checked) {
          for (var i=0; i<this.data.items.length; i++) {
            if (this.data.items[i].needed) {
              if (!this._isFiltered(this.data.items[i], true)) {
                tmp.push(this.data.items[i]);
              }
            }
          }
        } else {
          tmp = this._copyAll(true);
        }
        this.set('_itemsDisplay', tmp);
      }

      //-----------------------------------------------------------------------
      // code for done property
      //-----------------------------------------------------------------------
       // called when done is changed on an article
      _doneChanged(e) {
        var checked = e.target.checked;
        var id = e.target.id;
        if (this._isCompletedmode && checked) {
          this._spliceId(id);
        }
      }

       // called when needed mode is changed
      _completedModeChanged(e) {
        var checked = e.target.checked;
        var tmp = [];
        if (checked) {
          for (var i=0; i<this.data.items.length; i++) {
            if (!this.data.items[i].done) {
              if (!this._isFiltered(this.data.items[i], false)) {
                tmp.push(this.data.items[i]);
              }
            }
          }
        } else {
          tmp = this._copyAll(false);
        }
        this.set('_itemsDisplay', tmp);
      }

      //-----------------------------------------------------------------------
      // helper code
      //-----------------------------------------------------------------------
      // remove given id from displayed items
      _spliceId(id) {
        for (var i=0; i<this._itemsDisplay.length; i++) {
          if (this._itemsDisplay[i].id === id) {
            this.splice('_itemsDisplay', i, 1);
            return;
          }
        }
      }

      // when a  header checkbox has been checked we need to copy over all
      // items respecting the filter of the other header checkbox
      _copyAll(neededChanged) {
        var tmp = [];
        for (var i=0; i<this.data.items.length; i++) {
          if (!this._isFiltered(this.data.items[i], neededChanged)) {
            tmp.push(this.data.items[i]);
          }
        }
        return tmp;
      }

      // check weather an item is filtered when something is changed
      _isFiltered(item, neededChanged) {
          var filter = false;
          if (neededChanged) {
            if (this._isCompletedmode && item.done) {
              filter = true;
            }
          } else {
            if (this._isNeededmode && !item.needed) {
              filter = true;
            }          
          }
          return filter;    
      }
      
      // load localized messages
      attached() {
        console.log("sl-grid attached ");
        app.I18Nregister(this);
      }

      ready() {
        super.ready();
        console.log("sl-grid ready ");
      }

    }

    window.customElements.define(SlGrid.is, SlGrid);
  </script>
</dom-module>
